<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Provas de Concurso</title>
    <!-- Carrega o Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter (estilo Apple) --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilo minimalista (Apple) */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Estilos para as alternativas respondidas */
        .alternativa-item.correct {
            background-color: #D1FAE5; /* Tailwind green-100 */
            border-color: #34D399; /* Tailwind green-400 */
            color: #065F46; /* Tailwind green-800 */
            font-weight: 500;
        }
        .alternativa-item.wrong {
            background-color: #FEE2E2; /* Tailwind red-100 */
            border-color: #F87171; /* Tailwind red-400 */
            color: #991B1B; /* Tailwind red-800 */
            font-weight: 500;
        }
        
        /* Estilo para a alternativa correta (quando o usuário erra) */
        .alternativa-item.gabarito-correto {
             background-color: #D1FAE5; /* Tailwind green-100 */
             border-color: #34D399; /* Tailwind green-400 */
        }
        
        /* Oculta os spinners de inputs numéricos (embora não estejamos usando, é bom ter) */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilo para a transição dos sub-botões */
        .sub-buttons-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .sub-buttons-container.expanded {
            max-height: 300px; /* Ajuste conforme a altura máxima dos seus botões */
            transition: max-height 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- Cabeçalho --><header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Simulador de Provas</h1>
        </header>

        <!-- Controles de Seleção --><section class="mb-6 p-6 bg-white rounded-lg shadow-sm">
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <!-- Dropdown Disciplina --><div class="w-full sm:w-1/3">
                    <label for="selectDisciplina" class="block text-sm font-medium text-gray-700 mb-1">Disciplina</label>
                    <select id="selectDisciplina" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS --></select>
                </div>
                
                <!-- Dropdown Tema --><div class="w-full sm:w-1/3">
                    <label for="selectTema" class="block text-sm font-medium text-gray-700 mb-1">Tema</label>
                    <select id="selectTema" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS --></select>
                </div>

                <!-- Botão Carregar/Trocar --><div class="w-full sm:w-1/3 sm:mt-6">
                    <button id="btnCarregarProva" class="w-full px-6 py-3 font-semibold text-white rounded-md transition-all duration-300 bg-blue-600 hover:bg-blue-700 shadow-sm">
                        Carregar Prova
                    </button>
                </div>
            </div>
        </section>

        <!-- Área da Prova --><main id="areaProva">
            <!-- Status (Carregando, Erro, etc.) --><div id="divStatus" class="text-center text-gray-600 p-10 text-lg">
                Selecione a disciplina e o tema para começar.
            </div>

            <!-- Container das Questões --><div id="divQuestoes" class="space-y-6">
                <!-- As questões serão inseridas aqui via JS --></div>
        </main>

    </div>

    <!-- Carrega o "banco de dados" de disciplinas e temas PRIMEIRO --><script src="config.js"></script>

    <script type="module">
        // O objeto 'dbDisciplinas' é carregado do arquivo 'config.js'

        // --- 2. Referências aos Elementos do DOM ---
        
        const selectDisciplina = document.getElementById('selectDisciplina');
        const selectTema = document.getElementById('selectTema');
        const btnCarregarProva = document.getElementById('btnCarregarProva');
        const divStatus = document.getElementById('divStatus');
        const divQuestoes = document.getElementById('divQuestoes');

        // --- 3. Estado da Aplicação ---
        
        let provaCarregada = false;

        // --- 4. Funções Principais ---

        /**
         * Inicializa o simulador ao carregar a página.
         */
        function init() {
            popularDisciplinas();
            // Adiciona os listeners de eventos
            selectDisciplina.addEventListener('change', () => {
                popularTemas();
                resetarEstadoProva();
            });
            selectTema.addEventListener('change', resetarEstadoProva);
            btnCarregarProva.addEventListener('click', () => {
                // Se a prova já estiver carregada, o botão funciona como "Trocar"
                if (provaCarregada) {
                    resetarProvaCompleta();
                } else {
                    carregarProva();
                }
            });
        }

        /**
         * Popula o dropdown de Disciplinas com base no dbDisciplinas.
         */
        function popularDisciplinas() {
            selectDisciplina.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valor] of Object.entries(dbDisciplinas)) {
                const option = new Option(valor.nome, chave);
                selectDisciplina.add(option);
            }
            // Carrega os temas da primeira disciplina selecionada
            popularTemas();
        }

        /**
         * Popula o dropdown de Temas com base na disciplina selecionada.
         */
        function popularTemas() {
            const disciplinaKey = selectDisciplina.value;
            const temas = dbDisciplinas[disciplinaKey]?.temas || {};
            
            selectTema.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valor] of Object.entries(temas)) {
                const option = new Option(valor, chave);
                selectTema.add(option);
            }
        }

        /**
         * Reseta o estado do botão "Carregar Prova" se uma prova estava carregada.
         * Chamado quando o usuário muda um dropdown.
         */
        function resetarEstadoProva() {
            if (provaCarregada) {
                btnCarregarProva.textContent = 'Carregar Prova';
                btnCarregarProva.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                btnCarregarProva.classList.add('bg-blue-600', 'hover:bg-blue-700');
                provaCarregada = false;
                divStatus.textContent = 'Seleção alterada. Clique em "Carregar Prova".';
                divStatus.classList.remove('hidden');
            }
        }
        
        /**
         * Reseta a prova inteira (limpa questões) e volta ao estado inicial.
         * Chamado quando o usuário clica em "Trocar Prova".
         */
        function resetarProvaCompleta() {
            divQuestoes.innerHTML = '';
            divStatus.textContent = 'Selecione a disciplina e o tema para começar.';
            divStatus.classList.remove('hidden');
            resetarEstadoProva(); // Reseta o botão
        }

        /**
         * Busca o arquivo JSON e exibe a prova.
         */
        async function carregarProva() {
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;

            // Escolhe aleatoriamente uma prova de p1.json a p10.json
            const provaNum = Math.floor(Math.random() * 10) + 1;
            const url = `data/${disciplinaKey}/${temaKey}/p${provaNum}.json`;

            console.log(`Tentando carregar: ${url}`);
            
            // Atualiza UI para estado de carregamento
            divQuestoes.innerHTML = '';
            divStatus.textContent = 'Carregando prova...';
            divStatus.classList.remove('hidden');
            btnCarregarProva.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Arquivo não encontrado ou erro na rede (Status: ${response.status})`);
                }
                
                // O JSON deve ser um array de questões
                const questoes = await response.json(); 
                
                if (!Array.isArray(questoes) || questoes.length === 0) {
                     throw new Error("O arquivo JSON está vazio ou em formato inválido.");
                }

                exibirProva(questoes.slice(0, 20)); // Limita a 20 questões

                // Sucesso
                divStatus.classList.add('hidden');
                btnCarregarProva.textContent = 'Trocar Prova';
                btnCarregarProva.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnCarregarProva.classList.add('bg-gray-600', 'hover:bg-gray-700');
                provaCarregada = true;

            } catch (error) {
                console.error("Erro ao carregar prova:", error);
                divStatus.innerHTML = `
                    <p class="font-semibold text-red-600">Erro ao carregar a prova.</p>
                    <p class="text-sm text-gray-500 mt-2">Não foi possível encontrar o arquivo: <strong>${url}</strong></p>
                    <p class="text-sm text-gray-500 mt-1"><strong>Lembre-se:</strong> O preview não funciona. Você precisa hospedar os arquivos (ex: GitHub Pages) para que o simulador possa carregar os dados.</p>
                `;
            } finally {
                btnCarregarProva.disabled = false;
            }
        }

        /**
         * Renderiza as questões na tela.
         * @param {Array} questoes - Um array de objetos de questão.
         */
        function exibirProva(questoes) {
            divQuestoes.innerHTML = ''; // Limpa
            questoes.forEach((questao, index) => {
                const elementoQuestao = criarElementoQuestao(questao, index + 1);
                divQuestoes.appendChild(elementoQuestao);
                
                // Adiciona separador (exceto após a última questão)
                if (index < questoes.length - 1) {
                    const separador = document.createElement('hr');
                    separador.className = 'my-8 border-t border-gray-200';
                    divQuestoes.appendChild(separador);
                }
            });
        }

        /**
         * Cria o HTML para uma única questão.
         * @param {object} questao - O objeto da questão.
         * @param {number} numero - O número da questão (ex: 1, 2, 3...).
         * @returns {HTMLElement} - O elemento <div> do card da questão.
         */
        function criarElementoQuestao(questao, numero) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg shadow-md';
            card.dataset.id = questao.id || `q${numero}`;
            
            // 1. Metadados
            const metadata = document.createElement('p');
            metadata.className = 'text-xs text-gray-500 mb-3';
            metadata.textContent = `Questão ${numero} | ${questao.metadata || 'Sem metadados'}`;
            card.appendChild(metadata);

            // 2. Enunciado
            const enunciado = document.createElement('p');
            enunciado.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed';
            enunciado.textContent = questao.enunciado;
            card.appendChild(enunciado);

            // 3. Alternativas
            const alternativasContainer = document.createElement('div');
            alternativasContainer.className = 'space-y-3';
            
            (questao.alternativas || []).forEach(alt => {
                const altItem = document.createElement('div');
                altItem.className = 'alternativa-item flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50';
                // Usamos ml-4 para o recuo pedido
                altItem.style.marginLeft = '1rem'; 
                altItem.dataset.letra = alt.letra;
                
                altItem.innerHTML = `
                    <span class="font-semibold text-blue-600 w-6">${alt.letra})</span>
                    <span class="ml-2 text-gray-700">${alt.texto}</span>
                `;
                
                // Adiciona o listener para verificar a resposta
                altItem.addEventListener('click', () => {
                    verificarResposta(card, altItem, questao.gabarito);
                });
                
                alternativasContainer.appendChild(altItem);
            });
            card.appendChild(alternativasContainer);

            // 4. Gabarito (Oculto)
            const gabaritoDisplay = document.createElement('div');
            gabaritoDisplay.className = 'gabarito-oculto hidden mt-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-md font-medium';
            gabaritoDisplay.textContent = `Gabarito: ${questao.gabarito}`;
            card.appendChild(gabaritoDisplay);

            // 5. Botão principal e sub-botões de IA
            const mainAiButtonContainer = document.createElement('div');
            // Mobile: centralizado e largo; Desktop: alinhado à esquerda
            mainAiButtonContainer.className = 'mt-5 pt-4 border-t border-gray-100 flex flex-col items-center sm:items-start';

            const mainAiButton = document.createElement('button');
            mainAiButton.className = 'w-full sm:w-auto px-6 py-2 bg-blue-500 text-white rounded-md font-semibold hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center gap-2';
            mainAiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                        <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l4 4a1 1 0 0 1-1.414 1.414L11 5.414V14a1 1 0 1 1-2 0V5.414L6.707 7.707a1 1 0 0 1-1.414-1.414l4-4Z" clip-rule="evenodd" />
                                        <path fill-rule="evenodd" d="M.5 13.5A.5.5 0 0 1 1 13h18a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5ZM13 16.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z" clip-rule="evenodd" />
                                        </svg>
                                        Estudar com IA`;
            mainAiButtonContainer.appendChild(mainAiButton);

            const subButtonsContainer = document.createElement('div');
            subButtonsContainer.className = 'sub-buttons-container flex flex-col sm:flex-row flex-wrap gap-2 mt-2 w-full sm:w-auto';
            mainAiButtonContainer.appendChild(subButtonsContainer);

            mainAiButton.addEventListener('click', () => {
                subButtonsContainer.classList.toggle('expanded');
                // Altera o ícone do botão principal para indicar expansão/colapso
                const icon = mainAiButton.querySelector('svg');
                if (subButtonsContainer.classList.contains('expanded')) {
                    icon.classList.remove('rotate-0');
                    icon.classList.add('rotate-180'); // Rotaciona para baixo
                } else {
                    icon.classList.remove('rotate-180');
                    icon.classList.add('rotate-0'); // Volta para cima
                }
            });

            const promptsAI = [
                { 
                    texto: "Comentário Jurídico", 
                    tipo: "comentario", 
                    prompt: "Atue como um professor de direito. Comente o gabarito e fundamente sua explicação com embasamento jurídico detalhado, citando artigos de leis se possível. Explique por que a alternativa correta está certa e as outras estão erradas. Utilize uma linguagem formal e didática."
                },
                { 
                    texto: "Glossário Jurídico", 
                    tipo: "glossario", 
                    prompt: "Extraia os principais termos jurídicos ou conceitos complexos presentes no enunciado e nas alternativas. Para cada termo, forneça uma definição clara e concisa em formato de glossário."
                },
                { 
                    texto: "Dicas para Prova", 
                    tipo: "dicas", 
                    prompt: "Com base no tema desta questão, forneça 3 a 5 dicas práticas e estratégias de estudo para que um estudante possa se preparar melhor para provas de concurso, focando em como memorizar ou entender esse tipo de conteúdo. Fale sobre técnicas de memorização, mapas mentais, flashcards, etc."
                },
                { 
                    texto: "Vídeos do YouTube", 
                    tipo: "videos", 
                    prompt: "Sugira até 5 vídeos aulas do YouTube que abordem o tema desta questão. Forneça os títulos dos vídeos e os links diretos para cada um. Priorize vídeos de canais renomados e com boa didática." 
                }
            ];

            promptsAI.forEach(promptInfo => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 w-full sm:w-auto';
                btn.textContent = promptInfo.texto;
                btn.onclick = () => abrirGoogleIA(questao, promptInfo.prompt);
                subButtonsContainer.appendChild(btn);
            });
            card.appendChild(mainAiButtonContainer);

            return card;
        }

        /**
         * Processa a resposta do usuário.
         * @param {HTMLElement} card - O elemento do card da questão.
         * @param {HTMLElement} alternativaSelecionada - O elemento da alternativa clicada.
         * @param {string} gabarito - A letra correta (ex: "A").
         */
        function verificarResposta(card, alternativaSelecionada, gabarito) {
            // Impede de responder duas vezes
            if (card.dataset.respondida) return; 
            card.dataset.respondida = 'true';

            const letraSelecionada = alternativaSelecionada.dataset.letra;
            const gabaritoDisplay = card.querySelector('.gabarito-oculto');
            
            if (letraSelecionada === gabarito) {
                // Resposta Correta
                alternativaSelecionada.classList.add('correct');
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-green-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-green-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-green-800');
                
            } else {
                // Resposta Incorreta
                alternativaSelecionada.classList.add('wrong');
                // Destaca a correta
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) {
                    altCorreta.classList.add('gabarito-correto'); 
                }
                
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-red-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-red-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-red-800');
            }

            // Revela o gabarito
            gabaritoDisplay.classList.remove('hidden');
        }

        /**
         * Abre uma nova aba do Google (modo IA) com um prompt personalizado.
         * @param {object} questao - O objeto da questão.
         * @param {string} promptPredefinido - O prompt específico a ser enviado.
         */
        function abrirGoogleIA(questao, promptPredefinido) {
            // 1. Monta o contexto da questão
            let contexto = `Considere a seguinte questão de concurso:\n\nEnunciado: ${questao.enunciado}\n\nAlternativas:\n`;
            (questao.alternativas || []).forEach(alt => {
                contexto += `${alt.letra}) ${alt.texto}\n`;
            });
            contexto += `\nGabarito: ${questao.gabarito}\n\n`; // Incluir gabarito para IA ter contexto completo.

            // 2. Monta e codifica o prompt final
            const promptCompleto = `${promptPredefinido}\n\n${contexto}`;
            const urlQuery = encodeURIComponent(promptCompleto);
            
            // 3. Abre o Google Search (com o objetivo de ativar o modo IA)
            const googleUrl = `https://www.google.com/search?q=${urlQuery}`;
            
            window.open(googleUrl, '_blank');
        }

        // --- 5. Inicialização ---
        
        // Espera o DOM estar pronto e inicializa
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

