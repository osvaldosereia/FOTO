<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuJus - Simulador de Provas</title>
    <!-- Adiciona uma meta description para melhor indexação da página principal -->
    <meta name="description" content="MeuJus - Simulador de Provas de Concurso. Estude Direito Penal, Direito Civil, Português e mais com questões reais em Modo Estudo ou Modo Prova.">
    
    <!-- Carrega o Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a fonte Inter (estilo Apple) --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilo minimalista (Apple) */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- NOVOS ESTILOS PARA MODO PROVA --- */
        /* Alternativa SELECIONADA (Modo Prova) */
        .alternativa-item.selected {
            background-color: #DBEAFE; /* Tailwind blue-100 */
            border-color: #60A5FA; /* Tailwind blue-400 */
            color: #1E40AF; /* Tailwind blue-800 */
        }
        
        /* Estilos para as alternativas respondidas (Modo Estudo/Correção) */
        .alternativa-item.correct {
            background-color: #D1FAE5; /* Tailwind green-100 */
            border-color: #34D399; /* Tailwind green-400 */
            color: #065F46; /* Tailwind green-800 */
            font-weight: 500;
        }
        .alternativa-item.wrong {
            background-color: #FEE2E2; /* Tailwind red-100 */
            border-color: #F87171; /* Tailwind red-400 */
            color: #991B1B; /* Tailwind red-800 */
            font-weight: 500;
        }
        
        /* Estilo para a alternativa correta (quando o usuário erra) */
        .alternativa-item.gabarito-correto {
             background-color: #D1FAE5; /* Tailwind green-100 */
             border-color: #34D399; /* Tailwind green-400 */
         }

        /* Ícone da Bandeira (Flag) */
        .flag-icon {
            cursor: pointer;
            opacity: 0.4;
            transition: all 0.2s ease;
        }
        .flag-icon.flagged {
            opacity: 1;
            color: #EF4444; /* Tailwind red-500 */
            transform: scale(1.1);
        }
        
        /* Toggle Switch (Modo Prova) */
        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 0.125rem;  /* 2px */
            left: 0.125rem; /* 2px */
            background-color: #ffffff;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 9999px; /* rounded-full */
            height: 1.25rem;  /* 20px (h-5) */
            width: 1.25rem;   /* 20px (w-5) */
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); /* shadow-sm */
        }
        input:checked + .toggle-bg:after {
            transform: translateX(1.25rem); /* 20px (w-5) */
        }
        input:checked + .toggle-bg {
            background-color: #2563eb; /* bg-blue-600 */
            border-color: #2563eb; /* border-blue-600 */
        }
        
        /* Oculta os spinners de inputs numéricos */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilo para a transição dos sub-botões */
        .sub-buttons-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .sub-buttons-container.expanded {
            max-height: 300px; /* Ajuste conforme a altura máxima dos seus botões */
            transition: max-height 0.3s ease-in;
        }
        
    </style>
</head>
<body class="bg-gray-100">

    <!-- ### INÍCIO DO CABEÇALHO UNIFICADO ### -->
    <!-- Topbar full-width -->
    <nav class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">MeuJus</h1>
                </div>
                <!-- Navigation Links -->
                <div class="flex space-x-4">
                    <!-- Links relativos à raiz do domínio -->
                    <a href="/" class="text-blue-600 border-b-2 border-blue-600 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Simulador</a>
                    <a href="/vademecum/" class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Vademecum</a>
                </div>
            </div>
        </div>
    </nav>
    <!-- ### FIM DO CABEÇALHO UNIFICADO ### -->

    <!-- Conteúdo centralizado -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        
        <!-- ### SEÇÃO DE BOAS-VINDAS E CONTADOR ### -->
        <section class="mb-6 p-6 bg-white rounded-lg shadow-sm text-center">
            <h2 class="text-2xl font-semibold text-gray-800">Bem-vindo ao MeuJus!</h2>
            <p class="text-md text-gray-600 mt-1">
                Atualmente temos <span id="totalProvasCounter" class="font-bold text-blue-600">0</span> provas disponíveis.
            </p>
        </section>
        <!-- ### FIM DA SEÇÃO ### -->

        <!-- Controles de Seleção --><section class="mb-6 p-6 bg-white rounded-lg shadow-sm">
            <!-- Linha 1: Dropdowns -->
            <div class="flex flex-col sm:flex-row gap-4 items-center sm:items-start"> 
                <!-- Dropdown Disciplina --><div class="w-full sm:w-1/2">
                    <label for="selectDisciplina" class="block text-sm font-medium text-gray-700 mb-1">Disciplina</label>
                    <select id="selectDisciplina" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS --></select>
                </div>
                
                <!-- Dropdown Tema --><div class="w-full sm:w-1/2">
                    <label for="selectTema" class="block text-sm font-medium text-gray-700 mb-1">Tema</label>
                    <select id="selectTema" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <!-- Opções carregadas via JS --></select>
                    
                    <!-- Contador de Prova -->
                    <div id="divContadorProva" class="hidden text-sm font-medium text-gray-600 mt-2 ml-1">
                        <!-- Contador carregado via JS -->
                    </div>
                </div>
            </div>

            <!-- Linha 2: Histórico (LocalStorage) -->
            <div id="divHistorico" class="hidden mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm text-blue-800">
                <!-- Histórico carregado via JS -->
            </div>

            <!-- Linha 3: Modo Prova e Botão Carregar -->
            <div class="flex flex-col sm:flex-row gap-4 items-center mt-6">
                <!-- Toggle Modo Prova -->
                <div class="w-full sm:w-1/3 flex items-center justify-center sm:justify-start">
                    <label for="checkModoProva" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="checkModoProva" class="sr-only">
                            <div class="toggle-bg block bg-gray-200 border-2 border-gray-200 w-11 h-6 rounded-full transition"></div>
                        </div>
                        <div class="ml-3 text-sm font-medium text-gray-700">Modo Prova</div>
                    </label>
                </div>
                
                <!-- Botão Carregar/Trocar/Finalizar -->
                <div class="w-full sm:w-2/3">
                    <button id="btnCarregarProva" class="w-full px-6 py-3 font-semibold text-white rounded-md transition-all duration-300 bg-blue-600 hover:bg-blue-700 shadow-sm">
                        Carregar Prova
                    </button>
                </div>
            </div>
        </section>

        <!-- Área da Prova --><main id="areaProva">
            <!-- Placar Final e Filtros (Ocultos por padrão) -->
            <section id="divPlacar" class="hidden mb-6 p-6 bg-white rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Resultado da Prova</h2>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                    <div>
                        <span class="block text-sm text-gray-500">Acertos</span>
                        <span id="placarAcertos" class="text-2xl font-semibold text-green-600">0 / 0</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">Desempenho</span>
                        <span id="placarPercent" class="text-2xl font-semibold text-blue-600">0%</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">Tempo</span>
                        <span id="placarTempo" class="text-2xl font-semibold text-gray-700">00:00</span>
                    </div>
                    <div>
                        <span class="block text-sm text-gray-500">Sinalizadas</span>
                        <span id="placarSinalizadas" class="text-2xl font-semibold text-red-500">0</span>
                    </div>
                </div>
                <!-- Filtros -->
                <div id="divFiltros" class="flex flex-col sm:flex-row gap-2 justify-center mt-6">
                    <button id="btnFiltroTodas" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Mostrar Todas</button>
                    <button id="btnFiltroErradas" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">Mostrar Apenas Erradas</button>
                    <button id="btnFiltroSinalizadas" class="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">Mostrar Apenas Sinalizadas</button>
                </div>
            </section>
            
            <!-- Cronómetro (Oculto, só aparece no Modo Prova) -->
            <div id="divCronometro" class="hidden text-center text-lg font-semibold text-gray-700 mb-4 p-3 bg-white rounded-lg shadow-sm">
                Tempo: 00:00
            </div>

            <!-- Status (Carregando, Erro, etc.) --><div id="divStatus" class="text-center text-gray-600 p-10 text-lg">
                Selecione a disciplina e o tema para começar.
            </div>

            <!-- Container das Questões --><div id="divQuestoes" class="space-y-6">
                <!-- As questões serão inseridas aqui via JS --></div>
        </main>

    </div>

    <!-- Botão de Voltar ao Topo -->
    <button id="btnTopo" title="Voltar ao topo" class="hidden fixed bottom-6 right-6 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M10 17a.75.75 0 0 1-.75-.75V5.56l-2.72 2.72a.75.75 0 0 1-1.06-1.06l4-4a.75.75 0 0 1 1.06 0l4 4a.75.75 0 1 1-1.06 1.06l-2.72-2.72v10.69A.75.75 0 0 1 10 17Z" clip-rule="evenodd" />
        </svg>
    </button>


    <!-- Carrega o "banco de dados" de disciplinas e temas PRIMEIRO --><script src="config.js"></script>

    <script type="module">
        // O objeto 'dbDisciplinas' é carregado do arquivo 'config.js'

        // --- 2. Referências aos Elementos do DOM ---
        
        const selectDisciplina = document.getElementById('selectDisciplina');
        const selectTema = document.getElementById('selectTema');
        const btnCarregarProva = document.getElementById('btnCarregarProva');
        const divStatus = document.getElementById('divStatus');
        const divQuestoes = document.getElementById('divQuestoes');
        const btnTopo = document.getElementById('btnTopo');
        const totalProvasCounter = document.getElementById('totalProvasCounter'); // Contador
        
        // Novas referências
        const checkModoProva = document.getElementById('checkModoProva');
        const divPlacar = document.getElementById('divPlacar');
        const divFiltros = document.getElementById('divFiltros');
        const divHistorico = document.getElementById('divHistorico');
        const divCronometro = document.getElementById('divCronometro');
        const divContadorProva = document.getElementById('divContadorProva'); // Novo
        const btnFiltroTodas = document.getElementById('btnFiltroTodas');
        const btnFiltroErradas = document.getElementById('btnFiltroErradas');
        const btnFiltroSinalizadas = document.getElementById('btnFiltroSinalizadas');

        // --- 3. Estado da Aplicação ---
        
        let provaCarregada = false;
        let provaFinalizada = false;
        let respostasUsuario = {}; // Armazena { "q1": "A", "q2": "C", ... }
        let cronometroInterval = null;
        let segundosCronometro = 0;
        let urlProvaAtual = null; // Armazena a URL da prova carregada

        // --- 4. Funções Principais ---

        /**
         * Inicializa o simulador ao carregar a página.
         */
        function init() {
            // Validação: Verifica se o config.js foi carregado
            if (typeof dbDisciplinas === 'undefined') {
                console.error("ERRO CRÍTICO: O ficheiro config.js não foi carregado ou está vazio.");
                divStatus.innerHTML = `<p class="font-semibold text-red-600">Erro Crítico.</p>
                                        <p class="text-sm text-gray-500 mt-1">O ficheiro <b>config.js</b> não foi encontrado ou está vazio. Verifique o console (F12) para mais detalhes.</p>`;
                return; 
            }
            
            popularDisciplinas();
            calcularTotalProvas(); // Calcula o total de provas
            
            // --- Listeners de Eventos ---
            selectDisciplina.addEventListener('change', () => {
                popularTemas(); // Popula temas E atualiza o contador
                resetarEstadoProva();
            });
            selectTema.addEventListener('change', () => {
                resetarEstadoProva();
                atualizarContadorProvaUI(); // Atualiza contador ao mudar tema
            });
            checkModoProva.addEventListener('change', resetarEstadoProva);
            
            btnCarregarProva.addEventListener('click', () => {
                if (checkModoProva.checked && provaCarregada && !provaFinalizada) {
                    finalizarProva();
                } else {
                    carregarProva();
                }
            });

            // Listeners dos Filtros
            btnFiltroTodas.addEventListener('click', () => aplicarFiltro('todas'));
            btnFiltroErradas.addEventListener('click', () => aplicarFiltro('erradas'));
            btnFiltroSinalizadas.addEventListener('click', () => aplicarFiltro('sinalizadas'));
            
            // Listener do Botão Voltar ao Topo
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    btnTopo.classList.remove('hidden');
                } else {
                    btnTopo.classList.add('hidden');
                }
            });
            btnTopo.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        /**
         * Calcula o número total de provas no config.js e atualiza o contador.
         */
        function calcularTotalProvas() {
            let totalProvas = 0;
            if (typeof dbDisciplinas !== 'undefined') {
                for (const disciplinaKey in dbDisciplinas) {
                    const temas = dbDisciplinas[disciplinaKey].temas || {};
                    for (const temaKey in temas) {
                        totalProvas += temas[temaKey].provas || 0;
                    }
                }
            }
            totalProvasCounter.textContent = totalProvas;
        }

        /**
         * Popula o dropdown de Disciplinas com base no dbDisciplinas.
         */
        function popularDisciplinas() {
            selectDisciplina.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valor] of Object.entries(dbDisciplinas)) {
                const option = new Option(valor.nome, chave);
                selectDisciplina.add(option);
            }
            popularTemas(); // Carrega os temas (e o contador) da primeira disciplina
        }

        /**
         * Popula o dropdown de Temas e atualiza o contador.
         */
        function popularTemas() {
            const disciplinaKey = selectDisciplina.value;
            const temas = dbDisciplinas[disciplinaKey]?.temas || {};
            
            selectTema.innerHTML = ''; // Limpa opções anteriores
            for (const [chave, valorObj] of Object.entries(temas)) {
                const option = new Option(valorObj.nome, chave);
                selectTema.add(option);
            }
            // Após popular, atualiza o contador para o tema selecionado
            atualizarContadorProvaUI();
        }

        /**
         * Carrega e exibe o desempenho anterior SE for da mesma prova.
         */
        function carregarHistoricoProvaEspecifica(urlProvaCarregada) {
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;
            const storageKey = `meujus-score-${disciplinaKey}-${temaKey}`; // Chave de score
            
            const historicoJSON = localStorage.getItem(storageKey);
            divHistorico.classList.add('hidden'); // Esconde por padrão
            
            if (historicoJSON) {
                try {
                    const historicoData = JSON.parse(historicoJSON);
                    if (historicoData && historicoData.prova === urlProvaCarregada) {
                        divHistorico.textContent = `Último resultado nesta prova específica: ${historicoData.score}`;
                        divHistorico.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error("Erro ao parsear histórico do localStorage:", e);
                    localStorage.removeItem(storageKey); // Limpa dado inválido
                }
            }
        }

        /**
         * Reseta o estado da prova (chamado ao mudar seleção ou modo).
         */
        function resetarEstadoProva() {
            pararCronometro();
            divCronometro.classList.add('hidden');
            divPlacar.classList.add('hidden');
            divHistorico.classList.add('hidden'); // Garante que histórico some
            divQuestoes.innerHTML = ''; 
            
            provaCarregada = false;
            provaFinalizada = false;
            respostasUsuario = {};
            urlProvaAtual = null; // Reseta URL da prova
            
            btnCarregarProva.textContent = 'Carregar Prova';
            btnCarregarProva.classList.remove('bg-gray-600', 'hover:bg-gray-700', 'bg-red-600', 'hover:bg-red-700');
            btnCarregarProva.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            divStatus.textContent = 'Seleção alterada. Clique em "Carregar Prova".';
            divStatus.classList.remove('hidden');
            
            // Não reseta o contador, apenas garante que ele está visível
            atualizarContadorProvaUI();
        }
        
        /**
         * Busca o arquivo JSON e exibe a prova.
         */
        async function carregarProva() {
            // Reseta a UI da prova, mas não o contador
            pararCronometro();
            divCronometro.classList.add('hidden');
            divPlacar.classList.add('hidden');
            divHistorico.classList.add('hidden'); 
            divQuestoes.innerHTML = ''; 
            provaCarregada = false;
            provaFinalizada = false;
            respostasUsuario = {};
            urlProvaAtual = null;
            
            divStatus.textContent = 'Carregando prova...';
            divStatus.classList.remove('hidden');
            
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;
            const temaInfo = dbDisciplinas[disciplinaKey]?.temas[temaKey];
            
            if (!temaInfo || !temaInfo.provas || temaInfo.provas === 0) {
                divStatus.innerHTML = `<p class="font-semibold text-red-600">Erro de configuração.</p><p class="text-sm text-gray-500 mt-1">O tema selecionado (<b>${temaKey}</b>) não tem um número de provas (<b>provas: ...</b>) definido no arquivo <b>config.js</b>.</p>`;
                return; 
            }
            
            // ***** LÓGICA DE CARREGAMENTO SEQUENCIAL *****
            const numProvas = temaInfo.provas; 
            const indiceStorageKey = `meujus-index-${disciplinaKey}-${temaKey}`;
            const indiceAtual = parseInt(localStorage.getItem(indiceStorageKey) || '0', 10);
            
            // Calcula o próximo índice (ex: 0 -> 1, 1 -> 2, ..., 4 -> 1)
            const proximoIndice = (indiceAtual % numProvas) + 1; 
            
            // CAMINHO RELATIVO (assume que config.js e data/ estão na raiz)
            const url = `data/${disciplinaKey}/${temaKey}/p${proximoIndice}.json`;
            // ***** FIM DA LÓGICA SEQUENCIAL *****

            console.log(`Tentando carregar: ${url}`);
            btnCarregarProva.disabled = true;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Arquivo não encontrado (Status: ${response.status})`);
                
                const questoes = await response.json(); 
                if (!Array.isArray(questoes) || questoes.length === 0) throw new Error("O arquivo JSON está vazio ou em formato inválido.");

                exibirProva(questoes.slice(0, 20)); // Limita a 20 questões

                // Sucesso
                urlProvaAtual = url; // Armazena a URL da prova carregada
                
                // Salva o novo índice que acabamos de carregar
                localStorage.setItem(indiceStorageKey, proximoIndice);
                
                // Atualiza a UI do contador para mostrar o PRÓXIMO
                atualizarContadorProvaUI();
                
                // Verifica histórico da prova específica que acabamos de carregar
                carregarHistoricoProvaEspecifica(urlProvaAtual); 
                
                divStatus.classList.add('hidden');
                provaCarregada = true;

                if (checkModoProva.checked) {
                    btnCarregarProva.textContent = 'Finalizar Prova';
                    btnCarregarProva.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btnCarregarProva.classList.add('bg-red-600', 'hover:bg-red-700');
                    iniciarCronometro();
                } else {
                    btnCarregarProva.textContent = 'Trocar Prova (Modo Estudo)';
                    btnCarregarProva.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btnCarregarProva.classList.add('bg-gray-600', 'hover:bg-gray-700');
                }

            } catch (error) {
                console.error("Erro ao carregar prova:", error);
                divStatus.innerHTML = `<p class="font-semibold text-red-600">Erro ao carregar a prova.</p><p class="text-sm text-gray-500 mt-2">Não foi possível encontrar o arquivo: <strong>${url}</strong></p><p class="text-sm text-gray-500 mt-1">Verifique a sua estrutura de pastas e o <b>config.js</b>.</p>`;
                // Não reseta o estado, para o usuário ver o contador e tentar de novo
                divStatus.classList.remove('hidden');
                divQuestoes.innerHTML = '';
            } finally {
                btnCarregarProva.disabled = false;
            }
        }

        /**
         * Renderiza as questões na tela.
         */
        function exibirProva(questoes) {
            divQuestoes.innerHTML = ''; // Limpa
            questoes.forEach((questao, index) => {
                const elementoQuestao = criarElementoQuestao(questao, index + 1);
                divQuestoes.appendChild(elementoQuestao);
                
                if (index < questoes.length - 1) {
                    const separador = document.createElement('hr');
                    separador.className = 'my-8 border-t border-gray-200';
                    divQuestoes.appendChild(separador);
                }
            });
        }
        
        /**
         * Atualiza o texto do contador (ex: "Próxima prova: 1 / 10").
         */
        function atualizarContadorProvaUI() {
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;
            
            if (!disciplinaKey || !temaKey || !dbDisciplinas[disciplinaKey] || !dbDisciplinas[disciplinaKey].temas[temaKey]) {
                divContadorProva.classList.add('hidden');
                return;
            }

            const temaInfo = dbDisciplinas[disciplinaKey].temas[temaKey];
            const numProvas = temaInfo.provas;
            const indiceStorageKey = `meujus-index-${disciplinaKey}-${temaKey}`;
            
            // Lê o índice da prova que foi CARREGADA por último
            const indiceAtual = parseInt(localStorage.getItem(indiceStorageKey) || '0', 10);
            
            // Calcula qual será a PRÓXIMA
            const proximoIndice = (indiceAtual % numProvas) + 1; 

            divContadorProva.textContent = `Próxima prova a carregar: ${proximoIndice} / ${numProvas}`;
            divContadorProva.classList.remove('hidden');
        }

        /**
         * Cria o HTML para uma única questão.
         */
        function criarElementoQuestao(questao, numero) {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg shadow-md transition-all';
            card.dataset.id = questao.id || `q${numero}`;
            card.dataset.gabarito = questao.gabarito; 
            
            // 1. Metadados e Sinalizador (Flag)
            const metadataContainer = document.createElement('div');
            metadataContainer.className = 'flex justify-between items-center mb-3';
            const metadata = document.createElement('p');
            metadata.className = 'text-xs text-gray-500';
            metadata.textContent = `Questão ${numero} | ${questao.metadata || 'Sem metadados'}`;
            metadataContainer.appendChild(metadata);

            if (checkModoProva.checked) {
                const flagIcon = document.createElement('span');
                flagIcon.className = 'flag-icon';
                flagIcon.innerHTML = '🚩';
                flagIcon.title = 'Sinalizar questão para revisão';
                flagIcon.addEventListener('click', () => {
                    card.classList.toggle('flagged');
                    flagIcon.classList.toggle('flagged');
                });
                metadataContainer.appendChild(flagIcon);
            }
            card.appendChild(metadataContainer);

            // 2. Lógica do Enunciado (Simples vs. Complexo)
            if (questao.enunciado_principal && questao.itens_assertiva) {
                const enunciadoPrincipal = document.createElement('p');
                enunciadoPrincipal.className = 'text-base md:text-lg text-gray-800 mb-4 leading-relaxed';
                enunciadoPrincipal.innerHTML = formatarTexto(questao.enunciado_principal); // Aplica formatação
                card.appendChild(enunciadoPrincipal);

                const listaItens = document.createElement('ol');
                listaItens.className = 'list-none list-inside space-y-3 mb-4 pl-5 text-base md:text-lg text-gray-800 leading-relaxed';
                (questao.itens_assertiva || []).forEach(itemTexto => {
                    const li = document.createElement('li');
                    li.innerHTML = formatarTexto(itemTexto); // Aplica formatação
                    listaItens.appendChild(li);
                });
                card.appendChild(listaItens);

                if (questao.enunciado_pergunta) {
                    const perguntaFinal = document.createElement('p');
                    perguntaFinal.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed font-semibold';
                    perguntaFinal.innerHTML = formatarTexto(questao.enunciado_pergunta); // Aplica formatação
                    card.appendChild(perguntaFinal);
                }
            } else {
                const enunciado = document.createElement('p');
                enunciado.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed';
                const textoEnunciado = questao.enunciado || questao.enunciado_principal || "Enunciado não encontrado.";
                enunciado.innerHTML = formatarTexto(textoEnunciado); // Aplica formatação
                card.appendChild(enunciado);
            }

            // 3. Alternativas
            const alternativasContainer = document.createElement('div');
            alternativasContainer.className = 'space-y-3';
            (questao.alternativas || []).forEach(alt => {
                const altItem = document.createElement('div');
                altItem.className = 'alternativa-item flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50';
                altItem.style.marginLeft = '1rem'; 
                altItem.dataset.letra = alt.letra;
                // Aplica formatação ao texto da alternativa
                altItem.innerHTML = `<span class="font-semibold text-blue-600 w-6">${alt.letra})</span> <span class="ml-2 text-gray-700">${formatarTexto(alt.texto)}</span>`; 
                
                altItem.addEventListener('click', () => {
                    if (provaFinalizada) return;
                    if (checkModoProva.checked) {
                        selecionarResposta(card, altItem);
                    } else {
                        verificarRespostaModoEstudo(card, altItem);
                    }
                });
                alternativasContainer.appendChild(altItem);
            });
            card.appendChild(alternativasContainer);

            // 4. Gabarito (Oculto)
            const gabaritoDisplay = document.createElement('div');
            gabaritoDisplay.className = 'gabarito-oculto hidden mt-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-md font-medium';
            gabaritoDisplay.textContent = `Gabarito: ${questao.gabarito}`;
            card.appendChild(gabaritoDisplay);

            // 5. Botões de IA (só aparecem no Modo Estudo ou após finalizar a prova)
            const aiContainer = criarBotoesIA(questao);
            if (checkModoProva.checked) {
                aiContainer.classList.add('hidden'); // Esconde no Modo Prova
            }
            card.appendChild(aiContainer);

            return card;
        }
        
        /**
         * (Modo Prova) Seleciona uma resposta, armazena e destaca.
         */
        function selecionarResposta(card, alternativaSelecionada) {
            card.querySelectorAll('.alternativa-item').forEach(el => el.classList.remove('selected'));
            alternativaSelecionada.classList.add('selected');
            respostasUsuario[card.dataset.id] = alternativaSelecionada.dataset.letra;
        }

        /**
         * (Modo Estudo) Verifica a resposta imediatamente.
         */
        function verificarRespostaModoEstudo(card, alternativaSelecionada) {
            if (card.dataset.respondida) return; 
            card.dataset.respondida = 'true';
            const gabarito = card.dataset.gabarito;
            const letraSelecionada = alternativaSelecionada.dataset.letra;
            pintarCorrecao(card, gabarito, letraSelecionada);
        }

        /**
         * (Modo Prova) Chamada ao clicar em "Finalizar Prova".
         */
        function finalizarProva() {
            pararCronometro();
            provaFinalizada = true;
            btnCarregarProva.textContent = 'Carregar Nova Prova'; 
            btnCarregarProva.classList.remove('bg-red-600', 'hover:bg-red-700');
            btnCarregarProva.classList.add('bg-blue-600', 'hover:bg-blue-700'); 

            let acertos = 0;
            let sinalizadas = 0;
            const cards = divQuestoes.querySelectorAll('.bg-white');
            const total = cards.length;

            cards.forEach(card => {
                const id = card.dataset.id;
                const gabarito = card.dataset.gabarito;
                const resposta = respostasUsuario[id]; 
                const acertou = (gabarito === resposta);
                
                pintarCorrecao(card, gabarito, resposta);
                card.classList.add(acertou ? 'card-correto' : 'card-errado');
                if (acertou) acertos++;
                if (card.classList.contains('flagged')) sinalizadas++;
                card.querySelector('.ai-buttons-container').classList.remove('hidden');
            });
            
            const percent = total > 0 ? Math.round((acertos / total) * 100) : 0;
            document.getElementById('placarAcertos').textContent = `${acertos} / ${total}`;
            document.getElementById('placarPercent').textContent = `${percent}%`;
            document.getElementById('placarTempo').textContent = formatarTempo(segundosCronometro);
            document.getElementById('placarSinalizadas').textContent = sinalizadas;
            
            divPlacar.classList.remove('hidden');
            salvarDesempenho(acertos, total, percent); // Salva usando a URL da prova atual
            divPlacar.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /**
         * Pinta as alternativas de verde/vermelho (usado por ambos os modos).
         */
        function pintarCorrecao(card, gabarito, respostaUsuario) {
            const gabaritoDisplay = card.querySelector('.gabarito-oculto');
            gabaritoDisplay.classList.remove('hidden');
            const acertou = (gabarito === respostaUsuario);

            if (acertou) {
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) altCorreta.classList.add('correct');
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-green-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-green-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-green-800');
            } else {
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-red-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-red-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-red-800');
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) altCorreta.classList.add('gabarito-correto');
                if (respostaUsuario) {
                    const altErrada = card.querySelector(`.alternativa-item[data-letra="${respostaUsuario}"]`);
                    if (altErrada) altErrada.classList.add('wrong');
                }
            }
        }

        /**
         * Salva o placar final no localStorage, associado à URL da prova específica.
         */
        function salvarDesempenho(acertos, total, percent) {
            const disciplinaKey = selectDisciplina.value;
            const temaKey = selectTema.value;
            const storageKey = `meujus-score-${disciplinaKey}-${temaKey}`; // Chave de score
            const scoreString = `${acertos}/${total} (${percent}%) - em ${formatarTempo(segundosCronometro)}`;
            
            // Salva um objeto JSON com o score E a url da prova
            const dataToStore = JSON.stringify({ score: scoreString, prova: urlProvaAtual });
            
            localStorage.setItem(storageKey, dataToStore);
        }
        
        /**
         * Aplica filtros visuais (Todas, Erradas, Sinalizadas).
         */
        function aplicarFiltro(tipo) {
            const cards = divQuestoes.querySelectorAll('.bg-white');
            const separadores = divQuestoes.querySelectorAll('hr');
            let ultimoCardVisivel = null;

            // Reseta botões
            btnFiltroTodas.classList.remove('bg-blue-600', 'text-white');
            btnFiltroTodas.classList.add('bg-gray-200', 'text-gray-700');
            btnFiltroErradas.classList.remove('bg-blue-600', 'text-white');
            btnFiltroErradas.classList.add('bg-gray-200', 'text-gray-700');
            btnFiltroSinalizadas.classList.remove('bg-blue-600', 'text-white');
            btnFiltroSinalizadas.classList.add('bg-gray-200', 'text-gray-700');

            cards.forEach(card => {
                let mostrar = false;
                switch (tipo) {
                    case 'erradas': mostrar = card.classList.contains('card-errado'); break;
                    case 'sinalizadas': mostrar = card.classList.contains('flagged'); break;
                    default: mostrar = true;
                }
                card.style.display = mostrar ? 'block' : 'none';
                if (mostrar) ultimoCardVisivel = card;
            });
            
            // Destaca botão ativo
            if (tipo === 'todas') {
                btnFiltroTodas.classList.add('bg-blue-600', 'text-white');
                btnFiltroTodas.classList.remove('bg-gray-200', 'text-gray-700');
            } else if (tipo === 'erradas') {
                btnFiltroErradas.classList.add('bg-blue-600', 'text-white');
                btnFiltroErradas.classList.remove('bg-gray-200', 'text-gray-700');
            } else if (tipo === 'sinalizadas') {
                btnFiltroSinalizadas.classList.add('bg-blue-600', 'text-white');
                btnFiltroSinalizadas.classList.remove('bg-gray-200', 'text-gray-700');
            }

            // Esconde HRs
            separadores.forEach(hr => {
                hr.style.display = (hr.previousElementSibling && hr.previousElementSibling.style.display === 'none') ? 'none' : 'block';
            });
        }

        // --- Funções do Cronómetro ---
        
        function iniciarCronometro() {
            segundosCronometro = 0;
            divCronometro.textContent = 'Tempo: 00:00';
            divCronometro.classList.remove('hidden');
            cronometroInterval = setInterval(() => {
                segundosCronometro++;
                divCronometro.textContent = `Tempo: ${formatarTempo(segundosCronometro)}`;
            }, 1000);
        }

        function pararCronometro() {
            clearInterval(cronometroInterval);
            cronometroInterval = null;
        }

        function formatarTempo(segundos) {
            const min = Math.floor(segundos / 60);
            const seg = segundos % 60;
            return `${String(min).padStart(2, '0')}:${String(seg).padStart(2, '0')}`;
        }
        
        // --- Funções de Criação de UI (Botões IA) ---

        /**
         * Cria o container com os 4 botões de IA.
         */
        function criarBotoesIA(questao) {
            const mainAiButtonContainer = document.createElement('div');
            mainAiButtonContainer.className = 'ai-buttons-container mt-5 pt-4 border-t border-gray-100 flex flex-col items-center sm:items-start';

            const mainAiButton = document.createElement('button');
            mainAiButton.className = 'w-full sm:w-auto px-6 py-2 bg-blue-500 text-white rounded-md font-semibold hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center gap-2';
            mainAiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l4 4a1 1 0 0 1-1.414 1.414L11 5.414V14a1 1 0 1 1-2 0V5.414L6.707 7.707a1 1 0 0 1-1.414-1.414l4-4Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M.5 13.5A.5.5 0 0 1 1 13h18a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5ZM13 16.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z" clip-rule="evenodd" /></svg> Estudar com IA`;
            mainAiButtonContainer.appendChild(mainAiButton);

            const subButtonsContainer = document.createElement('div');
            subButtonsContainer.className = 'sub-buttons-container flex flex-col sm:flex-row flex-wrap gap-2 mt-2 w-full sm:w-auto';
            mainAiButtonContainer.appendChild(subButtonsContainer);

            mainAiButton.addEventListener('click', () => {
                subButtonsContainer.classList.toggle('expanded');
                const icon = mainAiButton.querySelector('svg');
                icon.classList.toggle('rotate-180');
            });

            const promptsAI = [
                { texto: "Comentário Jurídico", prompt: "Atue como um professor de direito. Comente o gabarito e fundamente sua explicação com embasamento jurídico detalhado, citando artigos de leis se possível. Explique por que a alternativa correta está certa e as outras estão erradas. Utilize uma linguagem formal e didática." },
                { texto: "Glossário Jurídico", prompt: "Extraia os principais termos jurídicos ou conceitos complexos presentes no enunciado e nas alternativas. Para cada termo, forneça uma definição clara e concisa em formato de glossário." },
                { texto: "Dicas para Prova", prompt: "Atue como um professor experiente em concursos. Com base no tema desta questão, forneça 3 a 5 dicas estratégicas e 'bizus' para NÃO cair em pegadinhas comuns da banca. Foque em erros frequentes que os candidatos cometem relacionados a este tema e como acertar as questões." },
                { texto: "Vídeos do YouTube", prompt: "Sugira até 5 vídeos aulas do YouTube que abordem o tema desta questão. Forneça os títulos dos vídeos e os links diretos para cada um. Priorize vídeos de canais renomados e com boa didática." }
            ];

            promptsAI.forEach(promptInfo => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 w-full sm:w-auto';
                btn.textContent = promptInfo.texto;
                btn.onclick = () => abrirGoogleIA(questao, promptInfo.prompt);
                subButtonsContainer.appendChild(btn);
            });
            
            return mainAiButtonContainer;
        }

        /**
         * Abre uma nova aba do Google (modo IA) com um prompt personalizado.
         */
        function abrirGoogleIA(questao, promptPredefinido) {
            let contexto = "Considere a seguinte questão de concurso:\n\n";
            if (questao.enunciado_principal && questao.itens_assertiva) {
                contexto += `Enunciado Principal: ${questao.enunciado_principal}\n\nItens:\n`;
                (questao.itens_assertiva || []).forEach((item, index) => {
                    contexto += `${item}\n`; 
                });
                if (questao.enunciado_pergunta) {
                    contexto += `\nPergunta: ${questao.enunciado_pergunta}\n`;
                }
            } else {
                contexto += `Enunciado: ${questao.enunciado || questao.enunciado_principal}\n`;
            }
            contexto += "\nAlternativas:\n";
            (questao.alternativas || []).forEach(alt => {
                contexto += `${alt.letra}) ${alt.texto}\n`;
            });
            contexto += `\nGabarito: ${questao.gabarito}\n\n`;

            const promptCompleto = `${promptPredefinido}\n\n${contexto}`;
            const urlQuery = encodeURIComponent(promptCompleto);
            const googleUrl = `https://www.google.com/search?udm=50&q=${urlQuery}`; // Link atualizado
            window.open(googleUrl, '_blank');
        }
        
        // ***** NOVA FUNÇÃO AUXILIAR *****
        /**
         * Converte texto com **negrito** e *itálico* para HTML.
         * @param {string} texto - O texto a ser formatado.
         * @returns {string} - O texto formatado como HTML.
         */
        function formatarTexto(texto) {
            if (!texto) return '';
            let html = texto;
            // Usa regex não-ganancioso (.*?) para lidar com múltiplas ocorrências
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            return html;
        }
        // ***** FIM DA NOVA FUNÇÃO *****

        // --- 5. Inicialização ---
        
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

